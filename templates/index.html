<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›½å†…é‡‘ä»·å®æ—¶ç›‘æ§ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        @keyframes pulse-up-color {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } /* Red for Up */
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        @keyframes pulse-down-color {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } /* Green for Down */
            50% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
        }
        .pulse-up { animation: pulse-up-color 2s infinite; }
        .pulse-down { animation: pulse-down-color 2s infinite; }
        .price-up { color: #ef4444; } /* Red */
        .price-down { color: #22c55e; } /* Green */
        
        /* Red Gradient for Up/Rise */
        .bg-up { background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); }
        /* Green Gradient for Down/Fall */
        .bg-down { background: linear-gradient(135deg, #065f46 0%, #047857 100%); }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* æ–°å¢ï¼šä»·æ ¼æ›´æ–°æ—¶çš„å¼¹è·³é«˜äº®æ•ˆæœ */
        @keyframes pop-in {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.05); filter: brightness(1.3); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .pop-effect {
            animation: pop-in 0.4s ease-out;
        }
        /* æ–°å¢ï¼šæ—¶é—´æ›´æ–°é—ªçƒæ•ˆæœ (å›å½’æ–‡å­—é—ªçƒç‰ˆ) */
        @keyframes time-flash {
            0%, 100% { color: inherit; }
            50% { color: #facc15; }
        }
        .time-pop {
            animation: time-flash 0.8s ease-out;
        }
        /* Vue è¿‡æ¸¡åŠ¨ç”» */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Modal Animation */
        .modal-enter-active, .modal-leave-active { transition: all 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.95); }
        .modal-enter-to, .modal-leave-from { opacity: 1; transform: scale(1); }

        /* Drawer Animation */
        .drawer-enter-active, .drawer-leave-active { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .drawer-enter-from, .drawer-leave-to { transform: translateX(100%); }
        .drawer-enter-to, .drawer-leave-from { transform: translateX(0); }
        
        /* ç§»é™¤ input type=number çš„é»˜è®¤ä¸Šä¸‹ç®­å¤´ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }

        .list-enter-active,
        .list-leave-active {
            transition: all 0.4s ease;
        }
        .list-enter-from,
        .list-leave-to {
            opacity: 0;
            transform: translateX(20px);
        }
        
        /* é¡¶éƒ¨å¯¼èˆªå…‰æ•ˆ */
        @keyframes shimmer {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }

        [v-cloak] { display: none; }

        /* å…¨å±€å­—ä½“ä¸å¹³æ»‘åº¦ä¼˜åŒ– */
        body {
            -webkit-font-smoothing: subpixel-antialiased;
            -moz-osx-font-smoothing: auto;
            text-rendering: optimizeLegibility;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ä¼˜åŒ– */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(31, 41, 55, 0.3);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(75, 85, 99, 0.4);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    
    {% raw %}
    <div id="app" v-cloak>
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="fixed top-0 left-0 right-0 z-[60] bg-gray-900 border-b border-gray-800 h-14 flex items-center justify-center gap-1 shadow-lg">
            <button @click="currentView = 'gold'" 
                    class="px-6 py-1.5 rounded-full text-sm font-bold transition-all duration-300 relative overflow-hidden group"
                    :class="currentView === 'gold' ? 'bg-yellow-500 text-black shadow-[0_0_15px_rgba(234,179,8,0.4)]' : 'text-gray-400 hover:text-gray-200 hover:bg-gray-800'">
                <span class="relative z-10">é‡‘ä»·ç›‘æ§</span>
                <div v-if="currentView === 'gold'" class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] animate-[shimmer_2s_infinite]"></div>
            </button>
            <div class="w-px h-4 bg-gray-700 mx-2"></div>
            <button @click="currentView = 'fund'" 
                    class="px-6 py-1.5 rounded-full text-sm font-bold transition-all duration-300 relative overflow-hidden group"
                    :class="currentView === 'fund' ? 'bg-blue-500 text-white shadow-[0_0_15px_rgba(59,130,246,0.4)]' : 'text-gray-400 hover:text-gray-200 hover:bg-gray-800'">
                <span class="relative z-10">åŸºé‡‘ä¼°å€¼</span>
            </button>
        </nav>

        <!-- é‡‘ä»·è§†å›¾ -->
        <div v-if="currentView === 'gold'" class="pt-14">
            <!-- åˆå§‹åŠ è½½é®ç½© -->
            <transition name="fade">
                <div v-if="isInitialLoading" class="fixed inset-0 z-[100] bg-gray-900 flex flex-col items-center justify-center">
                    <div class="w-16 h-16 border-4 border-yellow-500/20 border-t-yellow-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-yellow-500 font-bold animate-pulse">æ­£åœ¨è¿æ¥æ•°æ®æº...</p>
                </div>
            </transition>

            <!-- ä¸¥é‡é”™è¯¯é®ç½© (ä»…åœ¨å®Œå…¨æ— æ³•è·å–æ•°æ®æ—¶æ˜¾ç¤º) -->
            <transition name="fade">
                <div v-if="fetchError && !isInitialLoading" class="fixed inset-0 z-[90] bg-gray-900/95 backdrop-blur-sm flex flex-col items-center justify-center p-6 text-center">
                    <div class="text-6xl mb-6">ğŸ“¡</div>
                    <h2 class="text-2xl font-bold text-white mb-2">æœåŠ¡æš‚æ—¶ä¸å¯ç”¨</h2>
                    <p class="text-gray-400 mb-8 max-w-md">{{ fetchError }}ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åå†è¯•ã€‚</p>
                    <button @click="fetchPrice" class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold px-8 py-3 rounded-xl transition-all shadow-lg active:scale-95">
                        æ‰‹åŠ¨é‡è¯•
                    </button>
                    <p class="mt-4 text-xs text-gray-600">Au99.99 å®æ—¶ç›‘æ§ç³»ç»Ÿ</p>
                </div>
            </transition>

            <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
            <header class="fixed top-14 left-0 right-0 z-50 bg-gray-800/95 backdrop-blur-md border-b border-gray-700 py-4 px-6 shadow-md transition-all duration-300">
                <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex-1">
                    <h1 class="text-2xl font-bold text-yellow-400 hidden sm:block">Au99.99 å®æ—¶ç›‘æ§</h1>
                    <h1 class="text-lg font-bold text-yellow-400 sm:hidden">Au99.99</h1>
                    <p class="text-gray-400 text-xs flex items-center gap-2">
                        <span>{{ currentData.source || 'SGE' }}</span>
                    </p>
                </div>

                <!-- å®æ—¶ä»·æ ¼æ˜¾ç¤º (ä¸‹æ»‘æ—¶ä¾ç„¶å¯è§) -->
                <div class="flex-1 flex justify-center items-center">
                    <div class="bg-gray-900/50 px-4 py-1 rounded-full border border-gray-700 flex items-center gap-3"
                         :class="{'pop-effect': priceAnimating}">
                        <span class="text-2xl font-bold font-mono transition-colors duration-300"
                              :class="isPriceUp ? 'text-red-500' : 'text-green-500'">
                            {{ formatPrice(currentData.price) }}
                        </span>
                        <span class="text-sm font-mono px-2 py-0.5 rounded bg-gray-800"
                              :class="isPriceUp ? 'text-red-400' : 'text-green-400'">
                            {{ currentData.change >= 0 ? '+' : '' }}{{ currentData.change }}
                        </span>
                    </div>
                </div>

                <div class="flex-1 text-right">
                    <p class="text-gray-400 text-xs hidden sm:block">æ›´æ–°æ—¶é—´</p>
                    <p class="text-sm sm:text-lg font-mono" :class="{'time-pop': timeAnimating}">
                        {{ currentData.time_str || '--:--:--' }}
                    </p>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-6 pt-28">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- å·¦ä¾§ï¼šå®æ—¶ä»·æ ¼é¢æ¿ -->
                <div class="lg:col-span-1 space-y-6">
                    
                    <!-- ç²˜æ€§ä»·æ ¼å®¹å™¨ (ä»…åœ¨æ¡Œé¢ç«¯æœ‰æ•ˆï¼Œå› ä¸ºç§»åŠ¨ç«¯å·²ç”± Header è¦†ç›–) -->
                    <div class="lg:sticky lg:top-28 space-y-6">
                        <!-- å½“å‰ä»·æ ¼å¡ç‰‡ -->
                        <div class="rounded-2xl p-6 transition-all duration-500"
                            :class="[isPriceUp ? 'bg-up pulse-up' : 'bg-down pulse-down', {'pop-effect': priceAnimating}]">
                        <p class="text-gray-200 mb-2 opacity-80">å½“å‰é‡‘ä»· (å…ƒ/å…‹)</p>
                        <div class="flex items-baseline gap-3">
                            <span class="text-5xl font-bold font-mono transition-transform duration-300" 
                                  :class="{'scale-110': priceAnimating}">
                                {{ formatPrice(currentData.price) }}
                            </span>
                            <span class="text-xl font-mono" :class="isPriceUp ? 'text-red-200' : 'text-green-200'">
                                {{ currentData.change >= 0 ? '+' : '' }}{{ currentData.change }}
                            </span>
                            <!-- Source Badge -->
                            <span v-if="currentData.source" 
                                  class="text-xs px-2 py-0.5 rounded border border-white/20 ml-auto self-start mt-2 opacity-70"
                                  :title="'æ•°æ®æ¥æº: ' + currentData.source">
                                {{ currentData.source }}
                            </span>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-4 text-sm text-gray-200 opacity-90">
                            <div>
                                <p class="text-xs opacity-60">ä»Šå¼€</p>
                                <p class="font-mono">{{ formatPrice(currentData.open) }}</p>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">æ˜¨æ”¶</p>
                                <p class="font-mono">{{ formatPrice(currentData.yesterday_close) }}</p>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">æœ€é«˜</p>
                                <p class="font-mono text-red-300">{{ formatPrice(currentData.high) }}</p>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">æœ€ä½</p>
                                <p class="font-mono text-green-300">{{ formatPrice(currentData.low) }}</p>
                            </div>
                        </div>

                        <!-- æ–°å¢ï¼š24å°æ—¶æ³¢åŠ¨æ‘˜è¦ -->
                        <div v-if="currentData.volatility" class="mt-4 pt-4 border-t border-white/10 grid grid-cols-2 gap-4 text-sm text-gray-200 opacity-90">
                            <div class="col-span-2 flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-yellow-400/80">24H æ³¢åŠ¨æ‘˜è¦</span>
                                <span class="text-[10px] opacity-40">åŸºäº {{ currentData.count }} æ ·æœ¬</span>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">24H æœ€é«˜</p>
                                <p class="font-mono">{{ formatPrice(currentData.high_24h) }}</p>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">24H æœ€ä½</p>
                                <p class="font-mono">{{ formatPrice(currentData.low_24h) }}</p>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">24H æŒ¯å¹…</p>
                                <p class="font-mono text-yellow-300">{{ currentData.volatility }}</p>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">24H å‡ä»·</p>
                                <p class="font-mono">{{ formatPrice(currentData.avg_24h) }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- ä¹°å…¥ä»·æ ¼è®¾ç½® -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg">
                        <h3 class="text-lg font-semibold mb-4 text-yellow-400">æˆ‘çš„ä¹°å…¥æˆæœ¬</h3>
                        <div class="grid grid-cols-5 gap-2">
                            <!-- ä¹°å…¥ä»·æ ¼ (å 3ä»½) -->
                            <div class="col-span-3 flex">
                                <input type="number" v-model.number="buyPrice"
                                    @focus="handleInputFocus($event)" 
                                    @blur="handleInputBlur"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-l-lg px-4 py-3 text-xl font-mono focus:outline-none focus:border-yellow-500 transition-colors"
                                    placeholder="ä¹°å…¥ä»·" step="0.01">
                                <button @click="resetToCurrent" 
                                    class="bg-gray-600 hover:bg-gray-500 text-gray-300 px-3 py-3 rounded-r-lg transition border-l border-gray-500"
                                    title="é‡ç½®ä¸ºå½“å‰ä»·æ ¼">
                                    â†º
                                </button>
                            </div>
                            
                            <!-- ä¹°å…¥å…‹æ•° (å 2ä»½) -->
                            <div class="col-span-2 relative">
                                <input type="number" v-model.number="buyWeight"
                                    @focus="handleInputFocus($event)"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-xl font-mono focus:outline-none focus:border-yellow-500 transition-colors text-right pr-8"
                                    placeholder="å…‹æ•°" step="1">
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none">g</span>
                            </div>
                        </div>
                        <p class="text-gray-500 text-sm mt-2 flex justify-between">
                            <span>* æ‰‹ç»­è´¹ç‡: 0.5%</span>
                            <span v-if="buyPrice > 0" class="text-yellow-500/80">
                                æŒä»“: {{ buyWeight > 0 ? buyWeight : '--' }}g @ {{ buyPrice.toFixed(2) }}
                            </span>
                            <span v-else class="text-gray-600">æœªè®¾ç½®</span>
                        </p>
                    </div>

                    <!-- å½“å‰ç›ˆäºçŠ¶æ€ -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-700 transition-opacity duration-300"
                         :class="{'opacity-40 grayscale': !(buyPrice > 0)}">
                        <h3 class="text-lg font-semibold mb-4">å½“å‰ç›ˆäºçŠ¶æ€</h3>
                        <div class="text-center py-4">
                            <p class="text-gray-400 text-sm">è‹¥ç°åœ¨å–å‡º (æ‰£é™¤æ‰‹ç»­è´¹å)</p>
                            <p class="text-4xl font-bold font-mono my-2" 
                               :class="currentProfit.rate >= 0 ? 'text-red-500' : 'text-green-500'">
                               {{ buyPrice > 0 ? (currentProfit.rate >= 0 ? '+' : '') + currentProfit.rate + '%' : '--%' }}
                            </p>
                            <p class="text-gray-500 text-sm font-mono">
                                {{ buyWeight > 0 ? 'æ€»ç›ˆäº' : 'æ¯å…‹ç›ˆäº' }}: 
                                <span class="text-lg font-bold" :class="currentProfit.amount >= 0 ? 'text-red-400' : 'text-green-400'">
                                    {{ buyPrice > 0 ? (currentProfit.amount >= 0 ? '+' : '') + currentProfit.amount + ' å…ƒ' : '-- å…ƒ' }}
                                </span>
                            </p>
                        </div>
                        <!-- ç›ˆåˆ©è¿›åº¦æ¡ -->
                        <div class="mt-4 relative pt-6">
                            <div class="flex justify-between text-xs text-gray-500 mb-1 absolute top-0 w-full">
                                <span style="left: 0%">-10%</span>
                                <span style="left: 33.3%">0%</span>
                                <span style="right: 0">+20%</span>
                            </div>
                            <div class="h-3 bg-gray-700 rounded-full overflow-hidden relative">
                                <!-- 0ç‚¹å‚è€ƒçº¿ -->
                                <div class="absolute h-full w-0.5 bg-gray-600 left-1/3 z-10"></div>
                                <div class="h-full transition-all duration-500 relative"
                                     :style="buyPrice > 0 ? profitBarStyle : {width: '0%', left: '33.3%'}"
                                     :class="currentProfit.rate >= 0 ? 'bg-red-500' : 'bg-green-500'">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è®°å½•æŒ‰é’® -->
                    <button @click="recordPrice" 
                        :disabled="!(buyPrice > 0)"
                        class="w-full font-bold py-4 rounded-xl transition shadow-lg flex justify-center items-center gap-2"
                        :class="buyPrice > 0 ? 'bg-blue-600 hover:bg-blue-700 text-white hover:shadow-blue-900/50' : 'bg-gray-700 text-gray-500 cursor-not-allowed'">
                        <span>è®°å½•å½“å‰ä»·æ ¼</span>
                        <span v-if="isRecording" class="animate-spin">â³</span>
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå›¾è¡¨å’Œç›®æ ‡ -->
            <div class="lg:col-span-2 space-y-6">
                    
                    <!-- ä»·æ ¼èµ°åŠ¿å›¾ -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-700">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div class="flex items-center gap-4">
                                <h3 class="text-lg font-semibold">ä»·æ ¼èµ°åŠ¿</h3>
                                <div class="flex bg-gray-900/50 p-1 rounded-lg border border-gray-700">
                                    <button @click="setChartViewMode('30M')" 
                                            class="px-3 py-1 text-xs rounded-md transition-all"
                                            :class="chartViewMode === '30M' ? 'bg-yellow-500 text-black font-bold shadow-lg' : 'text-gray-400 hover:text-gray-200'">
                                        30åˆ†é’Ÿ
                                    </button>
                                    <button @click="setChartViewMode('1D')" 
                                            class="px-3 py-1 text-xs rounded-md transition-all"
                                            :class="chartViewMode === '1D' ? 'bg-yellow-500 text-black font-bold shadow-lg' : 'text-gray-400 hover:text-gray-200'">
                                        å½“æ—¥
                                    </button>
                                </div>
                            </div>
                            <span class="text-gray-500 text-[10px] sm:text-xs flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
                                {{ chartViewMode === '30M' ? 'å®æ—¶åŸå§‹æ•°æ®' : 'æ¯5ç§’æ›´æ–°' }}
                            </span>
                        </div>
                        <div class="h-64 relative">
                            <canvas id="priceChart" ref="priceChart" 
                                    class="transition-opacity duration-300"
                                    :class="chartSwitching ? 'opacity-0' : 'opacity-100'"></canvas>
                        </div>
                    </div>

                    <!-- ä»·æ ¼é¢„è­¦è®¾ç½® -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-yellow-400">ä»·æ ¼é¢„è­¦ (æµè§ˆå™¨é€šçŸ¥)</h3>
                            <div class="flex items-center gap-3">
                                <button @click="resetAlertsToDefault" class="text-[10px] text-gray-500 hover:text-yellow-500 border border-gray-700 px-2 py-1 rounded transition">
                                    é‡ç½®ä¸º Â±3%
                                </button>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" v-model="settings.enabled" @change="saveSettings" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                                </label>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">é‡‘ä»·é«˜äº (å…ƒ/å…‹)</label>
                                <input type="number" v-model.number="settings.high" @blur="saveSettings"
                                    class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-yellow-500"
                                    placeholder="0.00" step="0.01">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">é‡‘ä»·ä½äº (å…ƒ/å…‹)</label>
                                <input type="number" v-model.number="settings.low" @blur="saveSettings"
                                    class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-yellow-500"
                                    placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-3 italic">* å¼€å¯åè¯·ç¡®ä¿å…è®¸æµè§ˆå™¨é€šçŸ¥ã€‚è§¦å‘åå°†è¿›å…¥ 5 åˆ†é’Ÿå†·å´æœŸã€‚</p>
                    </div>

                    <!-- å¤šç›®æ ‡ç›ˆåˆ©è®¡ç®—è¡¨ -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-700 transition-opacity duration-300"
                         :class="{'opacity-40 grayscale': !(buyPrice > 0)}">
                        <h3 class="text-lg font-semibold mb-4 text-yellow-400">ç›®æ ‡å–å‡ºä»·æ ¼</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="text-gray-400 text-sm border-b border-gray-700">
                                        <th class="text-left py-3">ç›®æ ‡ç›ˆåˆ©</th>
                                        <th class="text-right py-3">{{ buyWeight > 0 ? 'æ€»ç›ˆåˆ©' : 'æ¯å…‹ç›ˆåˆ©' }}</th>
                                        <th class="text-right py-3">éœ€æ¶¨è‡³</th>
                                        <th class="text-right py-3">å®é™…æ¶¨å¹…</th>
                                        <th class="text-right py-3">è·ç›®æ ‡</th>
                                        <th class="text-right py-3">çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template v-if="buyPrice > 0">
                                        <tr v-for="target in targetTable" :key="target.percent" 
                                            class="border-b border-gray-700/50 hover:bg-gray-700/30 transition-colors"
                                            :class="{'bg-red-900/20': target.reached}">
                                            <td class="py-4">
                                                <span class="font-bold" :class="target.reached ? 'text-red-400' : 'text-yellow-400'">
                                                    +{{ target.percent }}%
                                                </span>
                                            </td>
                                            <td class="text-right py-4 font-mono text-blue-400">
                                                {{ target.profitAmount }} å…ƒ
                                            </td>
                                            <td class="text-right py-4 font-mono text-lg">{{ target.sellPrice }}</td>
                                            <td class="text-right py-4 text-gray-400 font-mono">+{{ target.requiredGain }}%</td>
                                            <td class="text-right py-4 font-mono">
                                                <span v-if="target.reached" class="text-red-400 font-bold">å·²è¾¾æˆ</span>
                                                <span v-else class="text-gray-400">{{ target.progress }}%</span>
                                            </td>
                                            <td class="text-right py-4">
                                                <span v-if="target.reached" class="px-2 py-1 bg-red-600/20 text-red-400 rounded text-xs border border-red-600/50">
                                                    å¯å–å‡º
                                                </span>
                                                <span v-else class="px-2 py-1 bg-gray-700 text-gray-400 rounded text-xs">
                                                    ç­‰å¾…ä¸­
                                                </span>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr v-else>
                                        <td colspan="5" class="py-12 text-center text-gray-500 italic">
                                            è¯·è¾“å…¥ä¹°å…¥æˆæœ¬ä»¥è®¡ç®—ç›®æ ‡
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- å†å²è®°å½• -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">ä»·æ ¼è®°å½•</h3>
                            <div class="flex gap-2">
                                <button @click="exportCSV" class="text-blue-400 hover:text-blue-300 text-sm px-3 py-1 hover:bg-blue-900/20 rounded transition">
                                    å¯¼å‡ºè®°å½•
                                </button>
                                <button @click="exportHistoryCSV" class="text-yellow-400 hover:text-yellow-300 text-sm px-3 py-1 hover:bg-yellow-900/20 rounded transition">
                                    å¯¼å‡º 24H å†å²
                                </button>
                                <button @click="clearRecords" class="text-red-400 hover:text-red-300 text-sm px-3 py-1 hover:bg-red-900/20 rounded transition">
                                    æ¸…ç©ºè®°å½•
                                </button>
                            </div>
                        </div>
                        <div class="space-y-2 max-h-64 overflow-y-auto pr-2 custom-scrollbar">
                            <div v-if="records.length === 0" class="text-gray-500 text-center py-8 bg-gray-700/20 rounded-lg">
                                æš‚æ— è®°å½•
                            </div>
                            <transition-group name="fade">
                                <div v-for="(record, index) in reversedRecords" :key="index" 
                                    class="flex justify-between items-center bg-gray-700/30 hover:bg-gray-700/50 rounded-lg p-3 border border-gray-700/50 transition-colors">
                                    <div>
                                        <span class="font-mono text-lg text-yellow-100">{{ formatPrice(record.price) }}</span>
                                        <span class="text-gray-500 text-sm ml-2 font-mono">{{ record.time_str }}</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-mono font-bold" 
                                            :class="parseFloat(record.profit) >= 0 ? 'text-red-400' : 'text-green-400'">
                                            {{ parseFloat(record.profit) >= 0 ? '+' : '' }}{{ record.profit }}%
                                        </span>
                                    </div>
                                </div>
                            </transition-group>
                        </div>
                    </div>
                </div>
            </div>
        </main>

            <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="fixed bottom-4 right-4 flex items-center gap-2 bg-gray-800 px-4 py-2 rounded-full shadow-lg border border-gray-700 z-50">
                <span class="w-3 h-3 rounded-full transition-colors duration-300" 
                      :class="[isConnected ? 'bg-green-500 animate-pulse' : 'bg-red-500']"></span>
                <span class="text-sm font-medium">{{ isConnected ? 'å®æ—¶è¿æ¥ä¸­' : 'è¿æ¥ä¸­æ–­' }}</span>
            </div>
        </div>

        <!-- åŸºé‡‘è§†å›¾ -->
        <div v-if="currentView === 'fund'" class="pt-20 px-4 max-w-4xl mx-auto min-h-screen">
            
            <!-- æˆ‘çš„æŒä»“å¡ç‰‡ -->
            <div class="mb-6 bg-gradient-to-br from-blue-900/40 to-purple-900/30 rounded-2xl border border-blue-500/20 overflow-hidden">
                <!-- æ ‡é¢˜æ  -->
                <div class="px-5 py-4 border-b border-blue-500/20 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold text-blue-300">æˆ‘çš„æŒä»“</h2>
                        <span v-if="holdingsSummary.count > 0" class="text-xs bg-blue-600/30 text-blue-300 px-2 py-0.5 rounded-full">
                            {{ holdingsSummary.count }} åª
                        </span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">{{ holdingsLastUpdate }}</span>
                        <button @click="openAddHoldingModal()" 
                                class="text-xs bg-green-600/20 hover:bg-green-600/40 text-green-300 px-3 py-1 rounded-lg transition-all"
                                title="æ·»åŠ æŒä»“">
                            + æ·»åŠ 
                        </button>
                        <button @click="fetchHoldings" 
                                :disabled="isLoadingHoldings"
                                class="text-xs bg-blue-600/20 hover:bg-blue-600/40 text-blue-300 px-3 py-1 rounded-lg transition-all"
                                title="åˆ·æ–°æ•°æ®">
                            {{ isLoadingHoldings ? 'åŠ è½½ä¸­...' : 'åˆ·æ–°' }}
                        </button>
                    </div>
                </div>
                
                <!-- æ±‡æ€»ä¿¡æ¯ -->
                <div v-if="holdingsSummary.count > 0" class="px-5 py-4 grid grid-cols-2 sm:grid-cols-4 gap-4 border-b border-blue-500/10">
                    <div class="text-center">
                        <p class="text-xs text-gray-400 mb-1">èµ„äº§æˆæœ¬</p>
                        <p class="text-lg font-bold font-mono text-gray-200">{{ holdingsSummary.total_cost.toFixed(2) }}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-400 mb-1">å½“å‰å¸‚å€¼</p>
                        <p class="text-lg font-bold font-mono text-blue-300">{{ holdingsSummary.total_value.toFixed(2) }}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-400 mb-1">ç´¯è®¡ç›ˆäº</p>
                        <p class="text-lg font-bold font-mono" :class="holdingsSummary.total_profit >= 0 ? 'text-red-400' : 'text-green-400'">
                            {{ holdingsSummary.total_profit >= 0 ? '+' : '' }}{{ holdingsSummary.total_profit.toFixed(2) }}
                        </p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-400 mb-1">æ€»æ”¶ç›Šç‡</p>
                        <p class="text-xl font-bold font-mono" :class="holdingsSummary.total_profit_rate >= 0 ? 'text-red-400' : 'text-green-400'">
                            {{ holdingsSummary.total_profit_rate >= 0 ? '+' : '' }}{{ holdingsSummary.total_profit_rate.toFixed(2) }}%
                        </p>
                    </div>
                </div>
                
                <!-- æŒä»“åˆ—è¡¨ -->
                <div class="px-5 py-4">
                    <div v-if="isLoadingHoldings" class="text-center py-8 text-gray-500">
                        <span class="animate-spin inline-block mr-2 text-2xl">â³</span>
                        <p class="text-sm">æ­£åœ¨åŠ è½½æŒä»“æ•°æ®...</p>
                    </div>
                    <div v-else-if="holdings.length === 0" class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-3 opacity-30">ğŸ“‹</div>
                        <p class="text-sm">æš‚æ— æŒä»“æ•°æ®</p>
                        <p class="text-xs mt-2 opacity-60">ç‚¹å‡»ä¸Šæ–¹ã€Œæ·»åŠ ã€æŒ‰é’®å½•å…¥æ‚¨çš„æŒä»“</p>
                    </div>
                    <div v-else class="space-y-3">
                        <div v-for="h in holdings" :key="h.code" 
                             @click="toggleHoldings(h)"
                             class="bg-gray-800/80 rounded-xl p-4 border border-blue-500/10 hover:border-blue-500/40 transition-all group relative overflow-hidden cursor-pointer">
                            
                            <!-- æŒä»“è¯¦æƒ… (ä¸‰æ®µå¼ç»ˆç«¯å¸ƒå±€) -->
                            <div class="space-y-4">
                                <!-- ç¬¬ä¸€æ®µï¼šåŸºé‡‘æ ‡é¢˜ -->
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center gap-2 overflow-hidden">
                                        <h4 class="font-bold text-white truncate text-base leading-tight">{{ h.name }}</h4>
                                        <span class="text-xs bg-gray-700 text-blue-200/90 px-1.5 py-0.5 rounded font-mono shrink-0">{{ h.code }}</span>
                                    </div>
                                    <div v-if="!h.data_available" class="text-xs bg-yellow-500/10 text-yellow-500 px-1.5 py-0.5 rounded border border-yellow-500/20 shrink-0">
                                        ç¦»çº¿æ›´æ–°
                                    </div>
                                </div>

                                <!-- ç¬¬äºŒæ®µï¼šæ ¸å¿ƒç›ˆäºæ•°æ® -->
                                <div class="flex items-end justify-between">
                                    <div class="flex flex-col">
                                        <span class="text-xs text-gray-400 mb-1 font-medium italic">æŒä»“ç´¯è®¡ç›ˆäº</span>
                                        <div class="flex items-baseline gap-2">
                                            <span class="text-3xl font-bold font-mono tracking-tighter"
                                                  :class="h.profit_rate >= 0 ? 'text-red-500' : 'text-green-500'">
                                                {{ (h.profit_rate >= 0 ? '+' : '') + h.profit_rate.toFixed(1) }}<span class="text-sm ml-0.5">%</span>
                                            </span>
                                            <span class="text-sm font-bold font-mono opacity-80"
                                                  :class="h.profit_amount >= 0 ? 'text-red-400' : 'text-green-400'">
                                                ({{ (h.profit_amount >= 0 ? '+' : '') + h.profit_amount.toFixed(0) }}å…ƒ)
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end text-right">
                                        <span class="text-xs text-gray-400 mb-1 font-medium tracking-tight">ä»Šæ—¥å˜åŒ–</span>
                                        <span class="text-lg font-bold font-mono px-2 py-0.5 rounded"
                                              :class="h.change >= 0 ? 'text-red-400 bg-red-900/20' : 'text-green-400 bg-green-900/20'">
                                            {{ h.change >= 0 ? '+' : '' }}{{ h.change }}%
                                        </span>
                                    </div>
                                </div>

                                <!-- ç¬¬ä¸‰æ®µï¼šèµ„äº§æ˜ç»† -->
                                <div class="grid grid-cols-3 gap-2 pt-3 border-t border-gray-700/30 text-gray-400">
                                    <div class="flex flex-col">
                                        <span class="text-xs text-gray-400 font-bold tracking-tighter uppercase opacity-80">æŒæœ‰ä»½æ•°</span>
                                        <span class="text-xs font-mono">{{ h.shares }}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-xs text-gray-400 font-bold tracking-tighter uppercase opacity-80">æŒä»“æˆæœ¬</span>
                                        <span class="text-xs font-mono">{{ h.cost_price }}</span>
                                    </div>
                                    <div class="flex flex-col items-end">
                                        <span class="text-xs text-gray-400 font-bold tracking-tighter uppercase opacity-80">å½“å‰å¸‚å€¼</span>
                                        <span class="text-sm text-blue-400 font-bold font-mono">{{ h.market_value.toFixed(1) }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- åº•éƒ¨æ‚¬æµ®åŠ¨ä½œæ¡ (Slide-up) -->
                            <div class="absolute bottom-0 left-0 right-0 h-12 bg-gray-900/95 backdrop-blur-md border-t border-blue-500/30 flex items-stretch translate-y-full group-hover:translate-y-0 transition-transform duration-300 ease-out z-10">
                                <!-- è¯¦æƒ… -->
                                <button @click.stop="toggleHoldings(h)" 
                                        class="flex-1 flex items-center justify-center gap-2 hover:bg-blue-500/10 transition-all text-gray-400 hover:text-blue-400 border-r border-gray-700/50 group/btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 transition-transform group-hover/btn:scale-110">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                                    </svg>
                                    <span class="text-xs font-bold">é‡ä»“è‚¡</span>
                                </button>
                                
                                <!-- ç¼–è¾‘ -->
                                <button @click.stop="openEditHoldingModal(h)" 
                                        class="flex-1 flex items-center justify-center gap-2 hover:bg-yellow-500/10 transition-all text-gray-400 hover:text-yellow-400 border-r border-gray-700/50 group/btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 transition-transform group-hover/btn:rotate-12">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                                    </svg>
                                    <span class="text-xs font-bold">ç¼–è¾‘</span>
                                </button>

                                <!-- åˆ é™¤ -->
                                <button @click.stop="deleteHolding(h.code)" 
                                        class="flex-1 flex items-center justify-center gap-2 hover:bg-red-500/10 transition-all text-gray-500 hover:text-red-400 group/btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 transition-transform group-hover/btn:scale-110">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                    </svg>
                                    <span class="text-xs font-bold">åˆ é™¤</span>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- æœç´¢æ·»åŠ æ  -->
            <div class="sticky top-20 z-40 bg-gray-900/90 backdrop-blur pb-4 pt-2">
                <div class="relative group">
                    <input type="text" v-model="newFundCode" @keyup.enter="addFund"
                           placeholder="è¾“å…¥6ä½åŸºé‡‘ä»£ç ï¼ŒæŒ‰å›è½¦æ·»åŠ åˆ°è‡ªé€‰..."
                           class="w-full bg-gray-800 border-2 border-gray-700 rounded-xl px-5 py-4 pl-12 text-lg focus:outline-none focus:border-blue-500 focus:shadow-[0_0_20px_rgba(59,130,246,0.2)] transition-all placeholder-gray-500">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 text-xl group-focus-within:text-blue-400 transition-colors">ğŸ”</span>
                    <button @click="addFund" 
                            :disabled="isAddingFund"
                            class="absolute right-3 top-1/2 -translate-y-1/2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-700 text-white px-4 py-1.5 rounded-lg text-sm font-bold transition-all">
                        {{ isAddingFund ? 'æ·»åŠ ä¸­...' : 'æ·»åŠ è‡ªé€‰' }}
                    </button>
                </div>
            </div>

            <!-- è‡ªé€‰åŸºé‡‘åˆ—è¡¨æ ‡é¢˜ -->
            <div class="flex items-center gap-2 mb-3 px-1">
                <span class="text-lg">ğŸ‘€</span>
                <h3 class="text-lg font-bold text-gray-400">è‡ªé€‰åŸºé‡‘</h3>
                <span v-if="funds.length > 0" class="text-xs text-gray-600">({{ funds.length }})</span>
            </div>

            <!-- åŸºé‡‘åˆ—è¡¨ -->
            <div class="space-y-3 pb-24">
                <div v-if="funds.length === 0" class="text-center py-20 text-gray-500">
                    <div class="text-6xl mb-4 opacity-20">ğŸ“Š</div>
                    <p>æš‚æ— è‡ªé€‰åŸºé‡‘</p>
                    <p class="text-sm opacity-60 mt-2">è¾“å…¥ä»£ç æ·»åŠ å…³æ³¨</p>
                </div>

                <transition-group name="list" tag="div" class="space-y-3">
                    <div v-for="fund in funds" :key="fund.code" 
                         @click="toggleHoldings(fund)"
                         class="bg-gray-800 rounded-xl p-4 pb-4 border border-gray-700/50 hover:border-blue-500/40 transition-all hover:bg-gray-750 group relative overflow-hidden cursor-pointer">
                        
                        <!-- æ ¸å¿ƒä¿¡æ¯åŒº (ä¸‰æ®µå¼) -->
                        <div class="space-y-3">
                            <!-- ç¬¬ä¸€æ®µï¼šå¤´éƒ¨æ ‡è¯† -->
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-2 overflow-hidden">
                                    <h3 class="font-bold text-white truncate">{{ fund.name }}</h3>
                                    <span class="text-xs bg-gray-700/80 text-gray-300 px-1.5 py-0.5 rounded font-mono shrink-0">{{ fund.code }}</span>
                                </div>
                                <div v-if="isFundInHoldings(fund.code)" 
                                     class="flex items-center gap-1 text-xs bg-blue-500/10 text-blue-300 px-2 py-0.5 rounded border border-blue-500/20 shrink-0 uppercase tracking-tighter">
                                    <span class="relative flex h-1.5 w-1.5">
                                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-blue-500"></span>
                                    </span>
                                    æŒä»“ä¸­
                                </div>
                            </div>

                            <!-- ç¬¬äºŒæ®µï¼šå…³é”®æŒ‡æ ‡ -->
                            <div class="flex items-end justify-between">
                                <div class="flex flex-col">
                                    <span class="text-xs text-gray-400 mb-1 font-medium italic">ä¼°ç®—æ¶¨è·Œ (å½“æ—¥)</span>
                                    <div class="flex items-baseline gap-1">
                                        <span class="text-3xl font-bold font-mono tracking-tighter transition-colors duration-300"
                                              :class="fund.change > 0 ? 'text-red-500' : (fund.change < 0 ? 'text-green-500' : 'text-gray-400')">
                                            {{ (fund.change > 0 ? '+' : '') + fund.change }}%
                                        </span>
                                        <div v-if="fund.animating" class="w-1.5 h-1.5 rounded-full bg-blue-400 animate-ping"></div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end text-right">
                                    <span class="text-xs text-gray-400 mb-1 font-mono uppercase tracking-wider">æœ€æ–°å‡€å€¼</span>
                                    <span class="text-lg font-bold text-gray-200 font-mono">{{ fund.price }}</span>
                                </div>
                            </div>

                            <!-- ç¬¬ä¸‰æ®µï¼šçŠ¶æ€è„šéƒ¨ -->
                            <div class="flex justify-between items-center pt-2 border-t border-gray-700/30">
                                <span class="text-xs text-gray-400 font-mono">{{ fund.time_str }}</span>
                                <span v-if="fund.source" class="text-xs text-gray-500">Source: {{ fund.source }}</span>
                            </div>
                        </div>

                        <!-- åº•éƒ¨æ‚¬æµ®åŠ¨ä½œæ¡ (Slide-up) -->
                        <div class="absolute bottom-0 left-0 right-0 h-12 bg-gray-900/95 backdrop-blur-md border-t border-blue-500/30 flex items-stretch translate-y-full group-hover:translate-y-0 transition-transform duration-300 ease-out z-10">
                            <!-- å±•å¼€é‡ä»“è‚¡ -->
                            <button @click.stop="toggleHoldings(fund)" 
                                    class="flex-1 flex items-center justify-center gap-2 hover:bg-blue-500/10 transition-colors text-gray-400 hover:text-blue-400 border-r border-gray-700/50">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                                </svg>
                                <span class="text-xs font-bold">é‡ä»“è‚¡</span>
                            </button>
                            
                            <!-- åŠ æŒä»“ -->
                            <button @click.stop="addFundToHoldings(fund)" 
                                    class="flex-1 flex items-center justify-center gap-2 hover:bg-green-500/10 transition-colors text-gray-400 hover:text-green-400 border-r border-gray-700/50">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span class="text-xs font-bold">å…¥æŒä»“</span>
                            </button>

                            <!-- ç§»é™¤ -->
                            <button @click.stop="deleteFund(fund.code)" 
                                    class="flex-1 flex items-center justify-center gap-2 hover:bg-red-500/10 transition-colors text-gray-500 hover:text-red-400">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                                <span class="text-xs font-bold">ç§»é™¤</span>
                            </button>
                        </div>
                    </div>
                </transition-group>
            </div>
            
            <!-- åº•éƒ¨æç¤º -->
            <div v-if="funds.length > 0" class="fixed bottom-6 left-0 right-0 text-center pointer-events-none">
                <span class="bg-gray-900/90 backdrop-blur-md px-4 py-1.5 rounded-full text-xs text-gray-400 border border-gray-800 shadow-lg font-medium">
                    æ•°æ®çº¦æ¯ 30 ç§’è‡ªåŠ¨åˆ·æ–° (ä»…äº¤æ˜“æ—¶æ®µ)
                </span>
            </div>
        </div>


        <!-- è‡ªå®šä¹‰æ¨¡æ€æ¡† (Modal) -->
        <transition name="modal">
            <div v-if="modal.visible" class="fixed inset-0 z-[100] flex items-center justify-center px-4" @keydown.esc="closeModal(false)">
                <!-- é®ç½©å±‚ -->
                <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" @click="closeModal(false)"></div>
                
                <!-- å¼¹çª—ä¸»ä½“ -->
                <div class="relative bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 w-full max-w-md p-6 transform transition-all">
                    <h3 class="text-xl font-bold mb-4 text-white">{{ modal.title }}</h3>
                    
                    <!-- Prompt æ¨¡å¼ä¸‹çš„è¾“å…¥æ¡† -->
                    <div v-if="modal.type === 'prompt'" class="mb-6">
                        <input ref="modalInput" 
                               v-model="modal.inputValue" 
                               @keyup.enter="closeModal(true)"
                               type="text" 
                               class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-yellow-500 transition-colors placeholder-gray-500"
                               :placeholder="modal.placeholder">
                    </div>

                    <!-- Confirm æ¨¡å¼ä¸‹çš„æç¤ºæ–‡æœ¬ -->
                    <div v-if="modal.type === 'confirm'" class="mb-6 text-gray-300">
                        {{ modal.message }}
                    </div>

                    <!-- æŒ‰é’®ç»„ -->
                    <div class="flex justify-end gap-3">
                        <button @click="closeModal(false)" 
                                class="px-5 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors font-medium">
                            å–æ¶ˆ
                        </button>
                        <button @click="closeModal(true)" 
                                class="px-5 py-2 rounded-lg font-bold transition-colors shadow-lg"
                                :class="modal.confirmButtonClass || 'bg-blue-600 hover:bg-blue-500 text-white'">
                            {{ modal.confirmText || 'ç¡®å®š' }}
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- æŒä»“ç¼–è¾‘æ¨¡æ€æ¡† -->
        <transition name="modal">
            <div v-if="holdingModal.visible" class="fixed inset-0 z-[100] flex items-center justify-center px-4">
                <!-- é®ç½©å±‚ -->
                <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" @click="closeHoldingModal()"></div>
                
                <!-- å¼¹çª—ä¸»ä½“ -->
                <div class="relative bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 w-full max-w-md p-6 transform transition-all">
                    <h3 class="text-xl font-bold mb-4 text-white">{{ holdingModal.isEdit ? 'ç¼–è¾‘æŒä»“' : 'æ·»åŠ æŒä»“' }}</h3>
                    
                    <div class="space-y-4">
                        <!-- åŸºé‡‘ä»£ç  -->
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">åŸºé‡‘ä»£ç </label>
                            <input type="text" v-model="holdingModal.code" 
                                   :disabled="holdingModal.isEdit"
                                   maxlength="6"
                                   class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors placeholder-gray-500 font-mono"
                                   :class="{'opacity-50 cursor-not-allowed': holdingModal.isEdit}"
                                   placeholder="6ä½åŸºé‡‘ä»£ç ">
                        </div>
                        
                        <!-- æˆæœ¬ä»· -->
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">æˆæœ¬ä»· (å…ƒ)</label>
                            <input type="number" v-model.number="holdingModal.costPrice" 
                                   step="0.0001"
                                   class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors placeholder-gray-500 font-mono"
                                   placeholder="å¦‚ 1.2345">
                        </div>
                        
                        <!-- æŒæœ‰ä»½é¢ -->
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">æŒæœ‰ä»½é¢</label>
                            <input type="number" v-model.number="holdingModal.shares" 
                                   step="0.01"
                                   class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors placeholder-gray-500 font-mono"
                                   placeholder="å¦‚ 1000">
                        </div>
                        
                        <!-- å¤‡æ³¨ -->
                        <div>
                            <label class="text-sm text-gray-400 block mb-1">å¤‡æ³¨ (å¯é€‰)</label>
                            <input type="text" v-model="holdingModal.note" 
                                   class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors placeholder-gray-500"
                                   placeholder="å¯é€‰å¤‡æ³¨ä¿¡æ¯">
                        </div>
                    </div>

                    <!-- æŒ‰é’®ç»„ -->
                    <div class="flex justify-end gap-3 mt-6">
                        <button @click="closeHoldingModal()" 
                                class="px-5 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors font-medium">
                            å–æ¶ˆ
                        </button>
                        <button @click="saveHolding()" 
                                :disabled="holdingModal.saving"
                                class="px-5 py-2 rounded-lg font-bold transition-colors shadow-lg bg-blue-600 hover:bg-blue-500 text-white disabled:bg-gray-600 disabled:cursor-not-allowed">
                            {{ holdingModal.saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜' }}
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- é‡ä»“è‚¡è¯¦æƒ…æŠ½å±‰ -->
        <div v-if="portfolioDrawer.visible" class="fixed inset-0 z-[110] overflow-hidden">
            <!-- é®ç½©å±‚ -->
            <transition name="fade" appear>
                <div v-if="portfolioDrawer.visible" class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" @click="closePortfolioDrawer()"></div>
            </transition>
            
            <!-- æŠ½å±‰ä¸»ä½“ -->
            <transition name="drawer" appear>
                <div v-if="portfolioDrawer.visible" class="absolute right-0 top-0 h-full w-full max-w-md bg-gray-800 shadow-2xl flex flex-col border-l border-gray-700">
                    <!-- æŠ½å±‰å¤´éƒ¨ -->
                    <div class="p-6 border-b border-gray-700 flex items-center justify-between bg-gray-800/80">
                        <div>
                            <h3 class="text-xl font-bold text-white">{{ portfolioDrawer.fundName }}</h3>
                            <p class="text-xs text-gray-400 font-mono mt-1 font-medium tracking-tight">{{ portfolioDrawer.fundCode }} â€¢ å‰åå¤§é‡ä»“è‚¡è¯¦æƒ…</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- å¼ºåˆ¶åˆ·æ–°æŒ‰é’® -->
                            <button @click="toggleHoldings({code: portfolioDrawer.fundCode, name: portfolioDrawer.fundName}, true)" 
                                    :disabled="portfolioDrawer.loading"
                                    class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-blue-500/10 text-gray-400 hover:text-blue-400 transition-all group/ref"
                                    title="åˆ·æ–°æŒä»“æ„æˆ">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" 
                                     class="w-5 h-5 transition-transform group-hover/ref:rotate-180 duration-500"
                                     :class="{'animate-spin': portfolioDrawer.loading}">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                                </svg>
                            </button>
                            <button @click="closePortfolioDrawer()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-700 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-gray-400">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- æŠ½å±‰å†…å®¹ -->
                    <div class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar">
                        <div v-if="portfolioDrawer.loading" class="flex flex-col items-center justify-center h-64 text-gray-400">
                            <span class="animate-spin text-4xl mb-4 text-blue-500">â³</span>
                            <p class="font-medium">æ­£åœ¨æ‹‰å–å®æ—¶è¡Œæƒ…...</p>
                        </div>
                        <div v-else-if="portfolioDrawer.holdings && portfolioDrawer.holdings.length > 0" class="space-y-4">
                            <!-- æ”¶ç›Šè´¡çŒ®æ±‡æ€» -->
                            <div class="bg-gray-900/60 rounded-2xl p-5 border border-blue-500/20 shadow-inner">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-gray-300 font-bold uppercase tracking-wider">å‰åå¤§é‡ä»“è´¡çŒ®é¢„ä¼°</span>
                                    <span class="text-xs bg-blue-500/10 text-blue-300 px-1.5 py-0.5 rounded border border-blue-500/20 scale-90">å®æ—¶ä¼°ç®—</span>
                                </div>
                                <div class="text-4xl font-bold font-mono tracking-tighter" 
                                     :class="getTotalContribution(portfolioDrawer.holdings) >= 0 ? 'text-red-400' : 'text-green-400'">
                                    {{ getTotalContribution(portfolioDrawer.holdings) >= 0 ? '+' : '' }}{{ getTotalContribution(portfolioDrawer.holdings).toFixed(3) }}<span class="text-lg ml-0.5">%</span>
                                </div>
                                <div class="mt-3 text-xs text-gray-400 flex items-center gap-1 font-medium">
                                    <span class="opacity-70">æ•°æ®æˆªæ­¢:</span>
                                    <span class="text-gray-300 italic">{{ portfolioDrawer.holdings[0]?.report_period || '--' }} å­£åº¦æŠ¥å‘ŠæœŸ</span>
                                </div>
                            </div>

                            <!-- è‚¡ç¥¨åˆ—è¡¨ -->
                            <div class="space-y-3 pb-8">
                                <div v-for="(stock, idx) in portfolioDrawer.holdings" :key="stock.code" 
                                     class="bg-gray-750/40 rounded-xl p-4 border border-gray-700/50 hover:bg-gray-700/60 hover:border-gray-600/50 transition-all group">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs text-gray-500 font-mono w-5 font-bold">{{ (idx + 1).toString().padStart(2, '0') }}</span>
                                                <h4 class="font-bold text-white truncate text-base leading-tight">{{ stock.name }}</h4>
                                            </div>
                                            <div class="text-xs text-gray-400 font-mono mt-1 opacity-80">{{ stock.code }}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold font-mono leading-none" :class="stock.change_percent >= 0 ? 'text-red-400' : 'text-green-400'">
                                                {{ stock.change_percent >= 0 ? '+' : '' }}{{ stock.change_percent.toFixed(2) }}%
                                            </div>
                                            <div class="text-[11px] font-bold font-mono mt-1 px-1.5 py-0.5 rounded inline-block" :class="stock.contribution >= 0 ? 'bg-red-900/10 text-red-400/80' : 'bg-green-900/10 text-green-400/80'">
                                                è´¡çŒ®: {{ (stock.contribution || 0).toFixed(3) }}%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-end text-xs mt-3 pt-3 border-t border-gray-700/30">
                                        <div class="text-gray-400 font-medium">
                                            æŒä»“å æ¯”: <span class="text-yellow-400/90 font-mono font-bold ml-1 text-sm">{{ stock.weight ? stock.weight.toFixed(2) + '%' : '--' }}</span>
                                        </div>
                                        <div class="text-gray-400 font-mono">
                                            ç°ä»·: <span class="text-gray-200 font-bold ml-1">{{ stock.price.toFixed(2) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-else class="flex flex-col items-center justify-center py-20 text-gray-500">
                            <div class="text-6xl mb-4 opacity-10">ğŸ‚</div>
                            <p>æš‚æ— é‡ä»“è‚¡æ•°æ®</p>
                            <p class="text-xs opacity-40 mt-2">è¯·ç¡®è®¤åŸºé‡‘ä»£ç æ˜¯å¦æ­£ç¡®æˆ–ç¨åé‡è¯•</p>
                        </div>
                    </div>
                    
                    <!-- æŠ½å±‰åº•éƒ¨ -->
                    <div class="p-6 border-t border-gray-700 bg-gray-900/30">
                        <div class="flex items-start gap-2 bg-blue-900/10 p-3 rounded-lg border border-blue-900/20">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mt-0.5 text-blue-400 shrink-0">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                            <p class="text-xs text-gray-400 leading-relaxed italic">
                                æ•°æ®æç¤ºï¼šå‰åå¤§é‡ä»“è‚¡ä¸ºå­£åº¦å…¬å¼€æŠ«éœ²æ•°æ®ï¼Œå…·æœ‰æ»åæ€§ã€‚å®æ—¶è´¡çŒ®åº¦åŸºäºå½“å‰è‚¡ç¥¨æ¶¨è·Œå¹…ä¼°ç®—ï¼Œä»…ä¾›åŸºé‡‘æ—¥å†…æ³¢åŠ¨å‚è€ƒï¼Œä¸ä»£è¡¨åŸºé‡‘å®é™…å‡€å€¼ã€‚
                            </p>
                        </div>
                    </div>
                </div>
            </transition>
        </div>

    </div>
    {% endraw %}

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // è§†å›¾çŠ¶æ€
                    currentView: 'gold', // 'gold' | 'fund'

                    // åŸºé‡‘æ•°æ®
                    funds: [],
                    newFundCode: '',
                    isAddingFund: false,
                    fundTimer: null,

                    // æŒä»“æ•°æ®
                    holdings: [],
                    holdingsSummary: { total_cost: 0, total_value: 0, total_profit: 0, total_profit_rate: 0, count: 0 },
                    holdingsLastUpdate: '--',
                    isLoadingHoldings: false,
                    holdingsTimer: null,
                    
                    // æŒä»“ç¼–è¾‘æ¨¡æ€æ¡†
                    holdingModal: {
                        visible: false,
                        isEdit: false,
                        code: '',
                        costPrice: '',
                        shares: '',
                        note: '',
                        saving: false
                    },

                    // é‡ä»“è‚¡æŠ½å±‰çŠ¶æ€
                    portfolioDrawer: {
                        visible: false,
                        loading: false,
                        fundName: '',
                        fundCode: '',
                        holdings: []
                    },

                    // æ•°æ®çŠ¶æ€
                    isInitialLoading: true, // æ–°å¢ï¼šåˆå§‹åŠ è½½çŠ¶æ€
                    fetchError: null,       // æ–°å¢ï¼šæŠ“å–é”™è¯¯ä¿¡æ¯
                    currentData: {
                        price: 0,
                        change: 0,
                        open: 0,
                        yesterday_close: 0,
                        high: 0,
                        low: 0,
                        time_str: '--:--:--'
                    },
                    buyPrice: 0,
                    buyWeight: 1, // é»˜è®¤ 1g
                    records: [],
                    historyData: [], // ç”¨äºå›¾è¡¨
                    chartViewMode: '1D', // '30M' | '1D'
                    
                    // ç³»ç»ŸçŠ¶æ€
                    isConnected: false,
                    isRecording: false,
                    hasInitializedBuyPrice: false,
                    timer: null,
                    tempBuyPrice: null, // ç”¨äºè¾“å…¥æ¡†è·å–ç„¦ç‚¹æ—¶æš‚å­˜æ•°æ®
                    priceAnimating: false, // æ§åˆ¶ä»·æ ¼è·³åŠ¨åŠ¨ç”»
                    chartSwitching: false, // æ§åˆ¶å›¾è¡¨åˆ‡æ¢åŠ¨ç”»
                    timeAnimating: false, // æ§åˆ¶æ—¶é—´æ›´æ–°åŠ¨ç”»
                    priceAnimTimer: null, // åŠ¨ç”»å®šæ—¶å™¨å¼•ç”¨
                    timeAnimTimer: null, // æ—¶é—´åŠ¨ç”»å®šæ—¶å™¨
                    // é¢„è­¦è®¾ç½®
                    settings: {
                        high: 0,
                        low: 0,
                        enabled: false
                    },
                    lastNotifiedTime: 0, // ä¸Šæ¬¡é€šçŸ¥æ—¶é—´
                    // æ¨¡æ€æ¡†çŠ¶æ€
                    modal: {
                        visible: false,
                        type: 'prompt', // 'prompt' | 'confirm'
                        title: '',
                        message: '',
                        placeholder: '',
                        inputValue: '',
                        confirmText: 'ç¡®å®š',
                        confirmButtonClass: '',
                        resolve: null // Promise resolve function
                    }
                    // chartInstance å·²ç§»é™¤ï¼Œé¿å… Vue ä»£ç†å¯¼è‡´çš„å›¾è¡¨å¡æ­»é—®é¢˜
                }
            },
            created() {
                this.chartInstance = null; // éå“åº”å¼å˜é‡
            },
            watch: {
                'portfolioDrawer.visible'(newVal) {
                    if (newVal) {
                        document.body.style.overflow = 'hidden';
                    } else {
                        document.body.style.overflow = '';
                    }
                },
                currentView(newVal) {
                    if (newVal === 'fund') {
                        // åˆ‡æ¢åˆ°åŸºé‡‘è§†å›¾æ—¶ï¼Œé”€æ¯å›¾è¡¨å®ä¾‹é˜²æ­¢æ®‹ç•™
                        if (this.chartInstance) {
                            this.chartInstance.destroy();
                            this.chartInstance = null;
                        }

                        this.fetchFunds();
                        this.fetchHoldings(); // åŠ è½½æŒä»“æ•°æ®
                        // åŸºé‡‘é¡µè½®è¯¢é—´éš”é•¿ (30s)
                        if (this.timer) clearInterval(this.timer);
                        this.timer = setInterval(() => {
                            this.fetchFunds();
                            this.fetchHoldings();
                        }, 30000); 
                    } else {
                        // åˆ‡æ¢å›é‡‘ä»·è§†å›¾æ—¶ï¼Œç«‹å³åˆ·æ–°å†å²æ•°æ®ä»¥å¡«è¡¥æ–­æ¡£
                        this.fetchHistory();
                        
                        this.fetchPrice();
                        // é‡‘ä»·é¡µè½®è¯¢é—´éš”çŸ­ (5s)
                        if (this.timer) clearInterval(this.timer);
                        this.timer = setInterval(this.fetchPrice, 5000);
                    }
                }
            },
            computed: {
                isPriceUp() {
                    return this.currentData.change >= 0;
                },
                currentProfit() {
                    if (!this.buyPrice || this.buyPrice <= 0 || !this.currentData.price) {
                        return { rate: '0.00', amount: '0.00' };
                    }
                    const feeRate = 0.005;
                    const actualReceive = this.currentData.price * (1 - feeRate);
                    const rate = ((actualReceive - this.buyPrice) / this.buyPrice * 100);
                    // åŸºç¡€æ¯å…‹ç›ˆäº
                    let amount = actualReceive - this.buyPrice;
                    
                    // å¦‚æœè®¾ç½®äº†å…‹æ•°ï¼Œåˆ™è®¡ç®—æ€»ç›ˆäº
                    if (this.buyWeight && this.buyWeight > 0) {
                        amount = amount * this.buyWeight;
                    }
                    
                    return {
                        rate: rate.toFixed(2),
                        amount: amount.toFixed(2)
                    };
                },
                profitBarStyle() {
                    const rate = parseFloat(this.currentProfit.rate);
                    // èŒƒå›´ -10% åˆ° +20% (æ€»è·¨åº¦ 30%)
                    // -10% å¯¹åº” left 0%
                    // 0% å¯¹åº” left 33.3%
                    // +20% å¯¹åº” left 100%
                    
                    if (rate <= -10) return { width: '0%', left: '0%' };
                    if (rate >= 20) return { width: '66.7%', left: '33.3%' };

                    if (rate < 0) {
                        // -10 åˆ° 0 ä¹‹é—´
                        const widthPct = ((rate + 10) / 10) * 33.3;
                        return { width: `${widthPct}%`, left: '0%' }; // ç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥é å³å¯¹é½åˆ°å‚è€ƒçº¿
                    } else {
                        // 0 åˆ° 20 ä¹‹é—´
                        const widthPct = (rate / 20) * 66.7;
                        return { width: `${widthPct}%`, left: '33.3%' };
                    }
                },
                targetTable() {
                    if (!this.buyPrice || this.buyPrice <= 0) return [];
                    
                    const targets = [5, 10, 15, 20, 30];
                    const feeRate = 0.005;
                    
                    return targets.map(percent => {
                        // ç›®æ ‡å–å‡ºä»· = ä¹°å…¥ä»· * (1 + åˆ©æ¶¦ç‡) / (1 - æ‰‹ç»­è´¹)
                        const sellPrice = this.buyPrice * (1 + percent / 100) / (1 - feeRate);
                        let profitAmount = (this.buyPrice * percent / 100);
                        
                        // å¦‚æœæœ‰å…‹æ•°ï¼Œè®¡ç®—æ€»ç›ˆåˆ©
                        if (this.buyWeight && this.buyWeight > 0) {
                            profitAmount = profitAmount * this.buyWeight;
                        }

                        const requiredGain = ((sellPrice - this.buyPrice) / this.buyPrice * 100);
                        const reached = this.currentData.price >= sellPrice;
                        // è®¡ç®—è¿›åº¦ 0-100%
                        const progress = Math.min(100, Math.max(0, 
                            (this.currentData.price - this.buyPrice) / (sellPrice - this.buyPrice) * 100
                        ));

                        return {
                            percent,
                            sellPrice: sellPrice.toFixed(2),
                            profitAmount: profitAmount.toFixed(2),
                            requiredGain: requiredGain.toFixed(2),
                            reached,
                            progress: progress.toFixed(1)
                        };
                    });
                },
                reversedRecords() {
                    return [...this.records].reverse();
                }
            },
            methods: {
                handleResize() {
                    if (this.chartInstance) {
                        this.chartInstance.options.layout.padding.right = window.innerWidth < 640 ? 60 : 110;
                        this.chartInstance.update('none');
                    }
                },
                formatPrice(val) {
                    return val ? Number(val).toFixed(2) : '--';
                },
                setChartViewMode(mode) {
                    if (this.chartViewMode === mode) return;
                    
                    // å¼€å¯åˆ‡æ¢åŠ¨ç”» (æ·¡å‡º)
                    this.chartSwitching = true;
                    
                    setTimeout(() => {
                        this.chartViewMode = mode;
                        if (this.chartInstance) {
                            const chartData = this.processDataForChart(this.historyData);
                            this.chartInstance.data.datasets[0].data = chartData;
                            
                            // æ›´æ–°è½´èŒƒå›´
                            const now = Date.now() / 1000;
                            if (mode === '30M') {
                                this.chartInstance.options.scales.x.min = now - 1800;
                                this.chartInstance.options.scales.x.max = now;
                            } else {
                                this.chartInstance.options.scales.x.min = undefined;
                                this.chartInstance.options.scales.x.max = undefined;
                            }
                            
                            // ä½¿ç”¨ 'none' ç¦ç”¨çº¿æ¡ä½ç§»è¡¥é—´åŠ¨ç”»ï¼Œé¿å…äº¤ç»‡
                            this.chartInstance.update('none');
                        }
                        
                        // ç»“æŸåˆ‡æ¢åŠ¨ç”» (æ·¡å…¥)
                        setTimeout(() => {
                            this.chartSwitching = false;
                        }, 50);
                    }, 300); // å¯¹åº” transition-opacity æ—¶é•¿
                },
                processDataForChart(rawData) {
                    if (!rawData || rawData.length === 0) return [];
                    
                    const now = Date.now() / 1000;
                    const maxGap = 10 * 60; // 10åˆ†é’Ÿæ²¡æœ‰æ•°æ®è§†ä¸ºæ–­æ¡£
                    
                    // æŒ‰æ—¶é—´æ’åº
                    const sortedData = [...rawData].sort((a, b) => a.timestamp - b.timestamp);
                    
                    let filteredData = [];

                    if (this.chartViewMode === '30M') {
                        // 30åˆ†é’Ÿæ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºåŸå§‹ç‚¹
                        filteredData = sortedData.filter(item => item.timestamp > now - 1800);
                    } else {
                        // 1D æ¨¡å¼ï¼šä¿ç•™èšåˆé€»è¾‘
                        const bucketSize = 5 * 60; // 5åˆ†é’Ÿä¸€æ¡¶
                        let buckets = {};
                        let recentData = [];

                        sortedData.forEach(item => {
                            const age = now - item.timestamp;
                            if (age <= 1800) { // æœ€è¿‘30åˆ†é’Ÿç”¨åŸå§‹ç‚¹
                                recentData.push(item);
                            } else {
                                const bucketKey = Math.floor(item.timestamp / bucketSize);
                                if (!buckets[bucketKey]) {
                                    buckets[bucketKey] = { min: item, max: item };
                                } else {
                                    if (item.price < buckets[bucketKey].min.price) buckets[bucketKey].min = item;
                                    if (item.price > buckets[bucketKey].max.price) buckets[bucketKey].max = item;
                                }
                            }
                        });

                        let bucketList = Object.values(buckets).flatMap(b => {
                            if (b.min.timestamp === b.max.timestamp) return [b.min];
                            return b.min.timestamp < b.max.timestamp ? [b.min, b.max] : [b.max, b.min];
                        });
                        
                        filteredData = [...bucketList, ...recentData].sort((a, b) => a.timestamp - b.timestamp);
                    }

                    // æ’å…¥æ–­æ¡£æ ‡è®° (null)
                    let finalData = [];
                    for (let i = 0; i < filteredData.length; i++) {
                        if (i > 0) {
                            const gap = filteredData[i].timestamp - filteredData[i-1].timestamp;
                            if (gap > maxGap) {
                                finalData.push({ x: (filteredData[i-1].timestamp + 1), y: null });
                            }
                        }
                        finalData.push({ x: filteredData[i].timestamp, y: filteredData[i].price });
                    }
                    
                    return finalData;
                },
                handleInputFocus(event) {
                    // ä¸å†æ¸…ç©º buyPriceï¼Œè€Œæ˜¯å…¨é€‰æ–‡å­—æ–¹ä¾¿ä¿®æ”¹
                    if (event && event.target) {
                        event.target.select();
                    }
                },
                handleInputBlur() {
                    // å¤±å»ç„¦ç‚¹æ—¶ï¼Œå¦‚æœä¸ºç©ºåˆ™ä¿æŒä¸ºç©ºï¼Œç­‰å¾…ç”¨æˆ·ä¸‹æ¬¡è¾“å…¥æˆ–ç‚¹å‡»é‡ç½®
                },
                resetToCurrent() {
                    if (this.currentData.price > 0) {
                        this.buyPrice = this.currentData.price;
                    }
                },
                async fetchPrice() {
                    try {
                        const res = await fetch('/api/price');
                        const data = await res.json();
                        
                        if (data.success) {
                            this.fetchError = null; // æ¸…é™¤é”™è¯¯
                            // æ£€æŸ¥æ•°æ®æ–°é²œåº¦ (20ç§’é˜ˆå€¼)
                            const now = Date.now() / 1000;
                            const isStale = (now - data.data.timestamp) > 20;
                            this.isConnected = !isStale;
                            
                            // æ£€æŸ¥é¢„è­¦
                            this.checkAlerts(data.data.price);

                            // é¦–æ¬¡åˆå§‹åŒ–ä¹°å…¥ä»·
                            if (!this.hasInitializedBuyPrice && data.data.price > 0) {
                                this.buyPrice = data.data.price;
                                
                                // è‡ªåŠ¨åˆå§‹åŒ–é¢„è­¦å€¼ä¸º +-3% (ä»…å½“å°šæœªè®¾ç½®è¿‡æ—¶)
                                if (this.settings.high === 0 && this.settings.low === 0) {
                                    this.settings.high = parseFloat((data.data.price * 1.03).toFixed(2));
                                    this.settings.low = parseFloat((data.data.price * 0.97).toFixed(2));
                                    this.saveSettings();
                                }
                                
                                this.hasInitializedBuyPrice = true;
                            }

                            // ä»…å½“ä»·æ ¼å‘ç”Ÿå˜åŒ–æˆ–é¦–æ¬¡åŠ è½½æ—¶æ‰è§¦å‘åŠ¨ç”»
                            const priceChanged = this.currentData.price !== data.data.price;
                            const timeChanged = this.currentData.time_str !== data.data.time_str;
                            
                            this.currentData = data.data;

                            // æ›´æ–°å›¾è¡¨æ•°æ®
                            this.updateChartData(data.data);
                            
                            // ä»·æ ¼è·³åŠ¨åŠ¨ç”»
                            if (priceChanged) {
                                if (this.priceAnimTimer) clearTimeout(this.priceAnimTimer);
                                // å¼ºåˆ¶é‡ç½®åŠ¨ç”»çŠ¶æ€ä»¥è§¦å‘ Vue é‡æ–°æ¸²æŸ“/CSS é‡æ–°å¼€å§‹
                                this.priceAnimating = false;
                                this.$nextTick(() => {
                                    this.priceAnimating = true;
                                    this.priceAnimTimer = setTimeout(() => {
                                        this.priceAnimating = false;
                                        this.priceAnimTimer = null;
                                    }, 400);
                                });
                            }

                            // æ—¶é—´é—ªçƒåŠ¨ç”»
                            if (timeChanged) {
                                if (this.timeAnimTimer) clearTimeout(this.timeAnimTimer);
                                this.timeAnimating = false;
                                this.$nextTick(() => {
                                    this.timeAnimating = true;
                                    this.timeAnimTimer = setTimeout(() => {
                                        this.timeAnimating = false;
                                        this.timeAnimTimer = null;
                                    }, 800);
                                });
                            }

                        } else {
                            this.isConnected = false;
                            // å¦‚æœä»·æ ¼è¿˜æ˜¯0ï¼Œè¯´æ˜ä»æœªè·å–æˆåŠŸè¿‡
                            if (this.currentData.price === 0) {
                                this.fetchError = data.message || 'è·å–æ•°æ®å¤±è´¥';
                            }
                        }
                    } catch (e) {
                        console.error(e);
                        this.isConnected = false;
                        if (this.currentData.price === 0) {
                            this.fetchError = 'ç½‘ç»œè¿æ¥å¼‚å¸¸';
                        }
                    } finally {
                        this.isInitialLoading = false;
                    }
                },
                async fetchHistory() {
                    try {
                        const res = await fetch('/api/history');
                        const data = await res.json();
                        if (data.success) {
                            this.historyData = data.data;
                            this.initChart();
                        }
                    } catch (e) { console.error(e); }
                },
                async fetchRecords() {
                    try {
                        const res = await fetch('/api/records');
                        const data = await res.json();
                        if (data.success) this.records = data.data;
                    } catch (e) { console.error(e); }
                },
                async fetchSettings() {
                    try {
                        const res = await fetch('/api/settings');
                        const data = await res.json();
                        if (data.success) this.settings = data.settings;
                    } catch (e) { console.error(e); }
                },
                resetAlertsToDefault() {
                    if (this.currentData.price > 0) {
                        this.settings.high = parseFloat((this.currentData.price * 1.03).toFixed(2));
                        this.settings.low = parseFloat((this.currentData.price * 0.97).toFixed(2));
                        this.saveSettings();
                    }
                },
                async saveSettings() {
                    if (this.settings.enabled && Notification.permission !== "granted") {
                        const permission = await Notification.requestPermission();
                        if (permission !== "granted") {
                            this.settings.enabled = false;
                            alert("éœ€è¦æµè§ˆå™¨é€šçŸ¥æƒé™æ‰èƒ½å¼€å¯é¢„è­¦ï¼Œå–µï¼");
                        }
                    }

                    try {
                        await fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.settings)
                        });
                    } catch (e) { console.error(e); }
                },
                checkAlerts(currentPrice) {
                    if (!this.settings.enabled || currentPrice <= 0) return;

                    const now = Date.now();
                    const cooldown = 5 * 60 * 1000; // 5åˆ†é’Ÿå†·å´

                    if (now - this.lastNotifiedTime < cooldown) return;

                    let msg = "";
                    if (this.settings.high > 0 && currentPrice >= this.settings.high) {
                        msg = `ğŸ“ˆ é‡‘ä»·å·²æ¶¨è‡³ ${currentPrice}ï¼Œè¶…è¿‡é¢„è­¦çº¿ ${this.settings.high}`;
                    } else if (this.settings.low > 0 && currentPrice <= this.settings.low) {
                        msg = `ğŸ“‰ é‡‘ä»·å·²è·Œè‡³ ${currentPrice}ï¼Œä½äºé¢„è­¦çº¿ ${this.settings.low}`;
                    }

                    if (msg) {
                        this.sendNotification("é‡‘ä»·æé†’ (Au99.99)", msg);
                        this.lastNotifiedTime = now;
                    }
                },
                sendNotification(title, body) {
                    if (Notification.permission === "granted") {
                        new Notification(title, {
                            body: body,
                            icon: "https://p3.itc.cn/images01/20210712/f6d76a7f34034442a8656157834241e3.png" // é‡‘ç‰Œå›¾æ ‡å ä½
                        });
                    }
                },
                
                // é€šç”¨ Modal æ–¹æ³•: Prompt
                openPrompt(title, placeholder = '') {
                    return new Promise((resolve) => {
                        this.modal = {
                            visible: true,
                            type: 'prompt',
                            title: title,
                            placeholder: placeholder,
                            inputValue: '',
                            confirmText: 'ç¡®è®¤è®°å½•',
                            confirmButtonClass: 'bg-blue-600 hover:bg-blue-500 text-white shadow-blue-900/50',
                            resolve: resolve
                        };
                        this.$nextTick(() => {
                            if(this.$refs.modalInput) this.$refs.modalInput.focus();
                        });
                    });
                },

                // é€šç”¨ Modal æ–¹æ³•: Confirm
                openConfirm(title, message, confirmText = 'ç¡®å®š', confirmClass = 'bg-red-600 hover:bg-red-500 text-white shadow-red-900/50') {
                    return new Promise((resolve) => {
                        this.modal = {
                            visible: true,
                            type: 'confirm',
                            title: title,
                            message: message,
                            confirmText: confirmText,
                            confirmButtonClass: confirmClass,
                            resolve: resolve
                        };
                    });
                },

                closeModal(result) {
                    if (this.modal.resolve) {
                        if (this.modal.type === 'prompt') {
                            // Prompt è¿”å›è¾“å…¥å€¼æˆ– null
                            this.modal.resolve(result ? this.modal.inputValue : null);
                        } else {
                            // Confirm è¿”å› true/false
                            this.modal.resolve(result);
                        }
                    }
                    this.modal.visible = false;
                    this.modal.resolve = null;
                },

                async recordPrice() {
                    if (this.isRecording) return;
                    
                    this.isRecording = true;
                    
                    const payload = {
                        price: this.currentData.price,
                        buy_price: this.buyPrice,
                        profit: this.currentProfit.rate,
                        note: '' // å¤‡æ³¨åŠŸèƒ½å·²å–æ¶ˆ
                    };

                    try {
                        const res = await fetch('/api/record', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (data.success) {
                            this.records.push(data.record);
                        }
                    } catch(e) { console.error(e); }
                    finally { this.isRecording = false; }
                },
                async clearRecords() {
                    // ä½¿ç”¨è‡ªå®šä¹‰ Modal æ›¿ä»£åŸç”Ÿ confirm
                    const confirmed = await this.openConfirm(
                        'ç¡®è®¤æ¸…ç©º', 
                        'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚',
                        'æ¸…ç©ºè®°å½•'
                    );
                    
                        if(!confirmed) return;
                    
                    try {
                        await fetch('/api/records/clear', { method: 'POST' });
                        this.records = [];
                    } catch(e) { console.error(e); }
                },
                exportCSV() {
                    if (this.records.length === 0) return;
                    
                    let csvContent = "\ufeff"; // BOM
                    csvContent += "æ—¶é—´,ä»·æ ¼(å…ƒ/å…‹),ä¹°å…¥æˆæœ¬,ç›ˆäºç‡(%)\n";
                    
                    this.records.forEach(r => {
                        csvContent += `${r.time_str},${r.price},${r.buy_price},${r.profit}\n`;
                    });
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url);
                    link.setAttribute("download", `gold_price_records_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },
                exportHistoryCSV() {
                    if (this.historyData.length === 0) return;
                    
                    let csvContent = "\ufeff"; // BOM
                    csvContent += "æ—¶é—´,ä»·æ ¼(å…ƒ/å…‹)\n";
                    
                    // æŒ‰ç…§æ—¶é—´é™åºæ’åˆ—ï¼Œæ–¹ä¾¿æŸ¥çœ‹
                    const sortedHistory = [...this.historyData].sort((a, b) => b.timestamp - a.timestamp);
                    
                    sortedHistory.forEach(h => {
                        const timeStr = new Date(h.timestamp * 1000).toLocaleString();
                        csvContent += `${timeStr},${h.price}\n`;
                    });
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url);
                    link.setAttribute("download", `gold_24h_history_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },
                initChart() {

                    if (this.chartInstance) return;

                    // ä½¿ç”¨ nextTick ç¡®ä¿ DOM å·²æ¸²æŸ“
                    this.$nextTick(() => {
                        const canvas = this.$refs.priceChart;
                        if (!canvas) return;

                        const ctx = canvas.getContext('2d');
                        const chartData = this.processDataForChart(this.historyData);

                        this.chartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                datasets: [{
                                    label: 'Au99.99 ä»·æ ¼',
                                    data: chartData,
                                    borderColor: '#facc15',
                                    borderWidth: 2,
                                    fill: true,
                                    // æ¸å˜å¡«å……
                                    backgroundColor: (context) => {
                                        const chart = context.chart;
                                        const {ctx, chartArea} = chart;
                                        if (!chartArea) return null;
                                        const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                                        gradient.addColorStop(0, 'rgba(250, 204, 21, 0.4)');
                                        gradient.addColorStop(1, 'rgba(250, 204, 21, 0)');
                                        return gradient;
                                    },
                                    tension: 0.4,
                                    spanGaps: false, // å¼ºåˆ¶æ–­æ¡£
                                    pointRadius: 0,
                                    pointHoverRadius: 4,
                                    pointBackgroundColor: '#facc15',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                layout: {
                                    padding: {
                                        top: 30,    // å¢åŠ é¡¶éƒ¨è¾¹è·ï¼Œé˜²æ­¢æœ€é«˜ä»·æ ‡ç­¾è¢«åˆ‡æ–­
                                        bottom: 20, // å¢åŠ åº•éƒ¨è¾¹è·ï¼Œé˜²æ­¢æœ€ä½ä»·æ ‡ç­¾é‡å 
                                        left: 5,
                                        right: window.innerWidth < 640 ? 60 : 110  // ç§»åŠ¨ç«¯åŠ¨æ€å‡å°‘å³ä¾§è¾¹è·
                                    }
                                },

                                animation: {
                                    duration: 1000,
                                    easing: 'easeOutQuart'
                                },
                                plugins: { 
                                    legend: { display: false },
                                    tooltip: {
                                        backgroundColor: 'rgba(31, 41, 55, 0.9)',
                                        titleColor: '#facc15',
                                        bodyFont: { family: 'monospace' },
                                        padding: 10,
                                        cornerRadius: 8,
                                        displayColors: false,
                                        callbacks: {
                                            title: (items) => {
                                                const timestamp = items[0].parsed.x;
                                                return new Date(timestamp * 1000).toLocaleString();
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: { 
                                        type: 'linear', // åˆ‡æ¢ä¸ºçº¿æ€§æ—¶é—´è½´
                                        min: this.chartViewMode === '30M' ? (Date.now() / 1000 - 1800) : undefined,
                                        max: this.chartViewMode === '30M' ? (Date.now() / 1000) : undefined,
                                        grid: { color: 'rgba(255,255,255,0.05)' }, 
                                        ticks: { 
                                            color: '#9ca3af', 
                                            maxTicksLimit: 8, 
                                            font: { size: 10 },
                                            callback: (value) => {
                                                const d = new Date(value * 1000);
                                                return `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                                            }
                                        } 
                                    },
                                    y: { 
                                        grid: { color: 'rgba(255,255,255,0.05)' }, 
                                        ticks: { 
                                            color: '#9ca3af',
                                            callback: (value) => value.toFixed(1),
                                            font: { size: 10 }
                                        } 
                                    }
                                },
                                 interaction: { intersect: false, mode: 'index' }
                            },
                            plugins: [{
                                id: 'highLowMarkers',
                                afterDatasetsDraw(chart) {
                                     const { ctx, scales: { x, y }, chartArea: { left, right } } = chart;
                                     const isMobile = window.innerWidth < 640;
                                     const dataset = chart.data.datasets[0].data;

                                    const minX = x.min;
                                    const maxX = x.max;
                                    const validData = dataset
                                        .filter(d => d.y !== null && d.x !== null)
                                        .filter(d => (minX === undefined || d.x >= minX) && (maxX === undefined || d.x <= maxX))
                                        .map(d => d.y);
                                    if (validData.length < 2) return;
 
                                    let minPrice = Math.min(...validData);
                                    let maxPrice = Math.max(...validData);

                                    
                                     const drawLabel = (val, color, label) => {
                                        const yPos = y.getPixelForValue(val);
                                        
                                        // ç»˜åˆ¶è™šçº¿
                                        ctx.strokeStyle = color;
                                        ctx.lineWidth = 1;
                                        ctx.setLineDash([5, 5]);
                                        ctx.beginPath();
                                        ctx.moveTo(left, yPos);
                                        ctx.lineTo(right, yPos);
                                        ctx.stroke();
                                        ctx.setLineDash([]);
                                        
                                         // è®¾ç½®æ ‡ç­¾æ–‡æœ¬
                                        const text = isMobile ? `${val.toFixed(1)}` : ` ${label}: ${val.toFixed(2)} `;
                                        ctx.font = isMobile ? 'bold 10px monospace' : 'bold 13px monospace';
                                        const textWidth = ctx.measureText(text).width;
                                        const textHeight = isMobile ? 16 : 22;
                                        
                                        // æ™ºèƒ½é¿è®©é€»è¾‘ï¼šå¦‚æœç¦»é¡¶éƒ¨å¤ªè¿‘ï¼Œæ ‡ç­¾å‘ä¸‹æ˜¾ç¤º
                                        const labelY = yPos < 30 ? yPos + 2 : yPos - (isMobile ? 8 : 11);

                                        // å°†æ ‡ç­¾æ”¾ç½®åœ¨å³è¾¹è·åŒºåŸŸï¼Œç¦»å›¾è¡¨è¾¹ç¼˜ 5px
                                        const labelX = right + 5; 
                                        
                                        // 1. ç»˜åˆ¶å®å¿ƒèƒŒæ™¯è‰²å— (çº¢è‰²æˆ–ç»¿è‰²)
                                        ctx.fillStyle = color;
                                        // ç»˜åˆ¶åœ†è§’çŸ©å½¢èƒŒæ™¯
                                        ctx.beginPath();
                                        const radius = 5;
                                        const x = labelX, y_rect = labelY, w = textWidth, h = textHeight;
                                        ctx.moveTo(x + radius, y_rect);
                                        ctx.lineTo(x + w - radius, y_rect);
                                        ctx.quadraticCurveTo(x + w, y_rect, x + w, y_rect + radius);
                                        ctx.lineTo(x + w, y_rect + h - radius);
                                        ctx.quadraticCurveTo(x + w, y_rect + h, x + w - radius, y_rect + h);
                                        ctx.lineTo(x + radius, y_rect + h);
                                        ctx.quadraticCurveTo(x, y_rect + h, x, y_rect + h - radius);
                                        ctx.lineTo(x, y_rect + radius);
                                        ctx.quadraticCurveTo(x, y_rect, x + radius, y_rect);
                                        ctx.closePath();
                                        ctx.fill();
                                        
                                        // 2. ç»˜åˆ¶ç™½è‰²æ–‡å­—
                                        ctx.fillStyle = '#FFFFFF';
                                        ctx.textAlign = 'left';
                                        ctx.textBaseline = 'top';
                                        ctx.fillText(text, labelX, labelY + 3);
                                        
                                        // 3. è¡¥å……ä¸€æ®µè™šçº¿å°†å›¾è¡¨çº¿å¼•å¯¼è‡³æ ‡ç­¾
                                        ctx.strokeStyle = color;
                                        ctx.setLineDash([2, 2]);
                                        ctx.beginPath();
                                        ctx.moveTo(right, yPos);
                                        ctx.lineTo(labelX, yPos);
                                        ctx.stroke();
                                        ctx.setLineDash([]);
                                    };


                                    drawLabel(maxPrice, 'rgba(239, 68, 68, 0.8)', 'H');
                                    drawLabel(minPrice, 'rgba(34, 197, 94, 0.8)', 'L');
                                }
                            }]
                        });
                    });
                },

                updateChartData(newData) {
                    if (!this.chartInstance) return;
                    
                    // å°†æ–°ç‚¹åŠ å…¥ historyData ä¾› processDataForChart ä½¿ç”¨
                    this.historyData.push(newData);

                    // å®šæœŸæ¸…ç†å‰ç«¯å†å²æ•°æ® (åªä¿ç•™æœ€è¿‘ 24 å°æ—¶)ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
                    const now = Date.now() / 1000;
                    if (this.historyData.length > 500) { // ç¨å¾®ç§¯ç´¯ä¸€ç‚¹å†æ¸…ç†
                        const dayAgo = now - 86400;
                        this.historyData = this.historyData.filter(h => h.timestamp > dayAgo);
                    }
                    
                    // é‡æ–°è®¡ç®—å¹¶å…¨é‡æ›´æ–°
                    const chartData = this.processDataForChart(this.historyData);
                    this.chartInstance.data.datasets[0].data = chartData;
                    
                    // 30M æ¨¡å¼ä¸‹åŠ¨æ€ç§»åŠ¨çª—å£
                    if (this.chartViewMode === '30M') {
                        const now = Date.now() / 1000;
                        this.chartInstance.options.scales.x.min = now - 1800;
                        this.chartInstance.options.scales.x.max = now;
                    }
                    
                    this.chartInstance.update('none'); 
                },
                
                // ==================== åŸºé‡‘é€»è¾‘ ====================
                async fetchFunds() {
                    try {
                        const res = await fetch('/api/funds');
                        const data = await res.json();
                        if (data.success) {
                            // åˆå¹¶æ•°æ®ä»¥ä¿ç•™åŠ¨ç”»çŠ¶æ€
                            const newMap = new Map(data.data.map(f => [f.code, f]));
                            
                            // æ›´æ–°ç°æœ‰åˆ—è¡¨æˆ–æ·»åŠ æ–°é¡¹
                            this.funds = data.data.map(newFund => {
                                const oldFund = this.funds.find(f => f.code === newFund.code);
                                const isChanged = oldFund && (oldFund.change !== newFund.change || oldFund.price !== newFund.price);
                                
                                return {
                                    ...newFund,
                                    animating: isChanged ? true : (oldFund ? oldFund.animating : false) // ç®€å•çš„è§¦å‘é€»è¾‘ï¼Œå®é™…å¯ä»¥ç”¨å®šæ—¶å™¨å¤ä½
                                };
                            });
                            
                            // ç®€å•çš„åŠ¨ç”»å¤ä½é€»è¾‘
                            setTimeout(() => {
                                this.funds.forEach(f => f.animating = false);
                            }, 500);
                            
                            this.isConnected = true;
                        }
                    } catch (e) {
                        console.error(e);
                        this.isConnected = false;
                    }
                },
                async addFund() {
                    if (!this.newFundCode || this.isAddingFund) return;
                    
                    this.isAddingFund = true;
                    try {
                        const res = await fetch('/api/funds/add', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ code: this.newFundCode })
                        });
                        const data = await res.json();
                        if (data.success) {
                            this.newFundCode = '';
                            this.fetchFunds(); // åˆ·æ–°åˆ—è¡¨
                        } else {
                            await this.openConfirm('æ·»åŠ å¤±è´¥', data.message, 'çŸ¥é“äº†', 'bg-gray-600');
                        }
                    } catch (e) {
                        console.error(e);
                    } finally {
                        this.isAddingFund = false;
                    }
                },

                async deleteFund(code) {
                    const confirmed = await this.openConfirm('ç¡®è®¤ç§»é™¤', `ç¡®å®šä¸å†å…³æ³¨åŸºé‡‘ ${code} å—ï¼Ÿ`, 'ç§»é™¤', 'bg-red-600');
                    if (!confirmed) return;
                    
                    try {
                        await fetch(`/api/funds/${code}`, { method: 'DELETE' });
                        this.funds = this.funds.filter(f => f.code !== code);
                    } catch (e) { console.error(e); }
                },
                
                async toggleHoldings(fund, force = false) {
                    // å¼€å¯å…¨å±æŠ½å±‰å±•ç¤ºé‡ä»“è‚¡
                    this.portfolioDrawer.fundName = fund.name;
                    this.portfolioDrawer.fundCode = fund.code;
                    if (!force) this.portfolioDrawer.holdings = []; 
                    this.portfolioDrawer.visible = true;
                    this.portfolioDrawer.loading = true;

                    try {
                        const url = `/api/funds/${fund.code}/portfolio` + (force ? '?refresh=true' : '');
                        const res = await fetch(url);
                        const data = await res.json();
                        if (data.success) {
                            this.portfolioDrawer.holdings = data.data;
                        }
                    } catch (e) {
                        console.error("è·å–é‡ä»“è‚¡å¤±è´¥", e);
                    } finally {
                        this.portfolioDrawer.loading = false;
                    }
                },

                closePortfolioDrawer() {
                    this.portfolioDrawer.visible = false;
                },
                
                getTotalContribution(holdings) {
                    // è®¡ç®—é‡ä»“è‚¡çš„ä¼°ç®—æ€»è´¡çŒ®
                    if (!holdings || !holdings.length) return 0;
                    return holdings.reduce((sum, stock) => sum + (stock.contribution || 0), 0);
                },

                // ==================== æŒä»“ç®¡ç†é€»è¾‘ ====================
                addFundToHoldings(fund) {
                    // ä»åŸºé‡‘å¡ç‰‡å¿«é€Ÿæ·»åŠ åˆ°æŒä»“ï¼Œé¢„å¡«åŸºé‡‘ä»£ç å’Œå½“å‰å‡€å€¼
                    this.holdingModal = {
                        visible: true,
                        isEdit: false,
                        code: fund.code,
                        costPrice: fund.price || '',
                        shares: '',
                        note: fund.name || '',
                        saving: false
                    };
                },
                
                isFundInHoldings(code) {
                    return this.holdings.some(h => String(h.code) === String(code));
                },

                async fetchHoldings() {
                    this.isLoadingHoldings = true;
                    try {
                        const res = await fetch('/api/holdings');
                        const data = await res.json();
                        if (data.success) {
                            this.holdings = data.data || [];
                            this.holdingsSummary = data.summary || { total_cost: 0, total_value: 0, total_profit: 0, total_profit_rate: 0, count: 0 };
                            this.holdingsLastUpdate = data.last_update || '--';
                        } else {
                            console.warn('åŠ è½½æŒä»“å¤±è´¥:', data.message);
                        }
                    } catch (e) {
                        console.error('è·å–æŒä»“æ•°æ®å¤±è´¥', e);
                    } finally {
                        this.isLoadingHoldings = false;
                    }
                },
                
                openAddHoldingModal() {
                    this.holdingModal = {
                        visible: true,
                        isEdit: false,
                        code: '',
                        costPrice: '',
                        shares: '',
                        note: '',
                        saving: false
                    };
                },
                
                openEditHoldingModal(holding) {
                    this.holdingModal = {
                        visible: true,
                        isEdit: true,
                        code: holding.code,
                        costPrice: holding.cost_price,
                        shares: holding.shares,
                        note: holding.note || '',
                        saving: false
                    };
                },
                
                closeHoldingModal() {
                    this.holdingModal.visible = false;
                },
                
                async saveHolding() {
                    const { code, costPrice, shares, note } = this.holdingModal;
                    
                    // åŸºæœ¬æ ¡éªŒ - ç¡®ä¿ code ä¸ºå­—ç¬¦ä¸²ç±»å‹
                    const codeStr = String(code || '').trim();
                    if (!codeStr || codeStr.length !== 6 || !/^\d{6}$/.test(codeStr)) {
                        await this.openConfirm('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½åŸºé‡‘ä»£ç ', 'çŸ¥é“äº†', 'bg-gray-600');
                        return;
                    }
                    if (!costPrice || costPrice <= 0) {
                        await this.openConfirm('è¾“å…¥é”™è¯¯', 'æˆæœ¬ä»·å¿…é¡»å¤§äº0', 'çŸ¥é“äº†', 'bg-gray-600');
                        return;
                    }
                    if (!shares || shares <= 0) {
                        await this.openConfirm('è¾“å…¥é”™è¯¯', 'ä»½é¢å¿…é¡»å¤§äº0', 'çŸ¥é“äº†', 'bg-gray-600');
                        return;
                    }
                    
                    this.holdingModal.saving = true;
                    try {
                        const res = await fetch('/api/holdings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                code: codeStr,
                                cost_price: costPrice,
                                shares: shares,
                                note: note
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            this.closeHoldingModal();
                            this.fetchHoldings(); // åˆ·æ–°åˆ—è¡¨
                        } else {
                            await this.openConfirm('ä¿å­˜å¤±è´¥', data.message, 'çŸ¥é“äº†', 'bg-gray-600');
                        }
                    } catch (e) {
                        console.error('ä¿å­˜æŒä»“å¤±è´¥', e);
                    } finally {
                        this.holdingModal.saving = false;
                    }
                },
                
                async deleteHolding(code) {
                    const confirmed = await this.openConfirm(
                        'ç¡®è®¤åˆ é™¤',
                        `ç¡®å®šè¦åˆ é™¤è¯¥æŒä»“è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`,
                        'åˆ é™¤'
                    );
                    if (!confirmed) return;
                    
                    try {
                        const res = await fetch(`/api/holdings/${code}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (data.success) {
                            this.fetchHoldings(); // åˆ·æ–°åˆ—è¡¨
                        } else {
                            await this.openConfirm('åˆ é™¤å¤±è´¥', data.message, 'çŸ¥é“äº†', 'bg-gray-600');
                        }
                    } catch (e) {
                        console.error('åˆ é™¤æŒä»“å¤±è´¥', e);
                    }
                }
            },
            mounted() {
                // åˆå§‹åŒ–åŠ è½½
                this.fetchHistory();
                this.fetchRecords();
                this.fetchSettings();
                this.fetchPrice();
                
                // é»˜è®¤å¯åŠ¨é‡‘ä»·è½®è¯¢
                this.timer = setInterval(this.fetchPrice, 5000);

                // å“åº”å¼ç›‘å¬
                window.addEventListener('resize', this.handleResize);
            },
            beforeUnmount() {
                if (this.timer) clearInterval(this.timer);
                window.removeEventListener('resize', this.handleResize);
                if (this.chartInstance) {
                    this.chartInstance.destroy();
                    this.chartInstance = null;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
